<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assignment Detail</title>
  <link rel="stylesheet" href="/css/assignment.css" />
  <link rel="stylesheet" href="/css/subject.css" /> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <div>EduTrack</div>
    <div class="user-actions">
      <button id="notifBtn"><i class="fas fa-bell"></i></button>
      <div class="popup notif-popup hidden" id="notifPopup">
        <div id="notifContent">No upcoming assignments</div>
      </div>
      <div id="userBtn">
        <div class="user-icon"><i class="fas fa-user"></i></div>
        <span id="currentUserName">User</span>
      </div>
      <div class="popup user-popup hidden" id="userPopup">
        <button id="userSettingsBtn">User Settings</button>
        <button id="aboutBtn">About</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Kontainer Assignment -->
  <div class="assignment-container">

    <!-- Tombol Back -->
    <div class="assignment-header">
      <button class="back-button" onclick="window.location.href='subject.html'">&#x3C;</button>
    </div>

    <!-- Assignment Title -->
    <h2 id="assignmentTitle">[Assignment]</h2>

    <!-- Input Subtask -->
    <input type="number" id="taskCount" placeholder="Jumlah nomor subtask" />
    <button onclick="generateSubtasks()">Buat Subtask</button>

    <!-- Subtask Box -->
    <div id="subtasks"></div>
    <div id="progressBar"><div id="progress"></div></div>
  </div>

  <!-- Script Subtask & Navbar -->
  <script>
    const assignment = JSON.parse(sessionStorage.getItem("currentAssignment"));
    if (!assignment) {
      alert("Assignment tidak ditemukan.");
      window.location.href = "subject.html";
    }

    let status = JSON.parse(sessionStorage.getItem("subtaskStatus_" + assignment.id)) || [];

    document.getElementById("assignmentTitle").innerText =
      `${assignment.name} - Deadline: ${assignment.deadline}`;

    function generateSubtasks() {
      const count = parseInt(document.getElementById("taskCount").value);
      if (!count || count < 1) return alert("Jumlah tidak valid");
      status = Array(count).fill(false);
      saveStatus();
      renderSubtasks();
    }

    function renderSubtasks() {
      const container = document.getElementById("subtasks");
      container.innerHTML = "";
      status.forEach((s, i) => {
        const box = document.createElement("div");
        box.className = "box" + (s ? " checked" : "");
        box.innerText = `Nomor ${i + 1}`;
        box.onclick = () => toggleStatus(i);
        container.appendChild(box);
      });
      updateProgress();
    }

    function toggleStatus(index) {
      status[index] = !status[index];
      saveStatus();
      renderSubtasks();
    }

    function updateProgress() {
      const done = status.filter(x => x).length;
      const total = status.length;
      const percent = total === 0 ? 0 : Math.round((done / total) * 100);
      document.getElementById("progress").style.width = percent + "%";
    }

    function saveStatus() {
      sessionStorage.setItem("subtaskStatus_" + assignment.id, JSON.stringify(status));
    }

    renderSubtasks();

    // Navbar logic
    document.addEventListener("DOMContentLoaded", () => {
      const fullName = sessionStorage.getItem("currentUserName") || "User";
      document.getElementById("currentUserName").textContent = fullName;

      const notifBtn = document.getElementById("notifBtn");
      const userBtn = document.getElementById("userBtn");
      const notifPopup = document.getElementById("notifPopup");
      const userPopup = document.getElementById("userPopup");

      notifBtn.addEventListener("click", () => {
        notifPopup.classList.toggle("hidden");
        userPopup.classList.add("hidden");
      });

      userBtn.addEventListener("click", () => {
        userPopup.classList.toggle("hidden");
        notifPopup.classList.add("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest("#userBtn") && !e.target.closest("#userPopup")) {
          userPopup.classList.add("hidden");
        }
        if (!e.target.closest("#notifBtn") && !e.target.closest("#notifPopup")) {
          notifPopup.classList.add("hidden");
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
